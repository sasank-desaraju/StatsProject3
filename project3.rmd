---
title: "Project 3"
author: "Sasank Desaraju, Phuc Pham, Natalie Geigel, Christopher Ludka"
date: "11/18/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(car)
library(knitr)
library(emmeans)
library(tidymodels)

```

#Introduction: 

#A Priori: 

# Scientific Hypotheses (Planned Analysis):

```{r planned-data-carpentry}
dataset <- readRDS("./data/group3_data.rds")

tidy_dataset <- dataset %>%
  rename(ID = record_id,
         Flanker_test = tb_flanker_unadj_ss,
         Pic_Seq_Mem_Test = tb_picseq_unadj_ss,
         Moca_Score = moca_unadj,
         Musical_Practice = champs_q17c,
         Age = gi_age,
         Education_Level = gi_degree,
         Second_Language = gi_2ndlang_yn,
         Track_Activity = pac_track_doing,
         Paying_Attention = pac_pay_attention,
         Concentration = pac_concentrate,
         Indecisiveness = bdi_indecisiveness,
         Remembering = pac_remember,
         R_Parahippo_vol = fs_parahpc_vol_r,
         L_Parahippo_vol = fs_parahpc_vol_l,
         Est_Tot_intra_cranial_vol = fs_etiv
         ) %>%
  mutate(Second_Language = if_else(condition = is.na(Second_Language), "No", "Yes")) %>% 
  mutate(Musical_Practice = if_else(condition = is.na(Musical_Practice), 0 , as.numeric(Musical_Practice))) %>% 
  # mutate(Musical_Practice = if_else(condition = is.na(Track_Activity), 0 , as.numeric(Track_Activity))) %>% 
  mutate(Musical_Practice = as_factor(Musical_Practice),
         Education_Level = as_factor(Education_Level),
         Second_Language = as_factor(Second_Language),
         Paying_Attention = as_factor(Paying_Attention),
         Track_Activity = as_factor(Track_Activity),
         Concentration = as_factor(Concentration),
         Indecisiveness = as_factor(Indecisiveness),
         Remembering = as_factor(Remembering),
         Moca_Score = as.numeric(Moca_Score),
         Age = as.numeric(Age)
  )
dataset
tidy_dataset
```

## Hypothesis 1: The ability to pay attention, proxied by Flanker’s test of attention, can be explained by behavioral habits and a self-reported score when accounting for age and education level. These behavioral habits are ones that have been connected in literature to better brain performance: musical practice and fluency in multiple languages. The self-reported score asks the subject about their ability to pay attention in a distracting environment. 

```{r}
hypo_one_dataset <- tidy_dataset %>%
  select(ID,
         Flanker_test,
         Age,
         Musical_Practice,
         Second_Language,
         Education_Level,
         Track_Activity
  )
  

hypo_one_dataset
```
### Statistical Hypothesis:

Ho: Flanker’s test scores will not be significantly different for different behavioral habits, accounting for age and education. 

Ha: Flanker’s test scores will be significantly different for different behavioral 	habits, accounting for age and education. 

### Statistical Model:
$$\begin{aligned}
\hat{y}_{Flanker.Test} = \beta_{Age}X_{Age}? + \beta_{Music}X_{Music}? +
\beta_{Language}X_{Language}? + \beta_{Education}X_{Education}? + \beta_{Track}X_{Track}?
\end{aligned}$$

### Visualization:
```{r}
#Age vs. Flanker's Test
ggplot(data = hypo_one_dataset, aes(x = Age,
                                    y = Flanker_test)) +
  geom_point() +
  geom_smooth(method = lm, formula = `y` ~ `x`, se = F) +
  xlab("Age") +
  ylab("Flanker's Test Unadjusted Score") + 
  labs(title = "Age vs. Flanker's Test") + 
  theme(plot.title = element_text(size = rel(1.2), hjust = 0.5))

#Musical Practice vs. Flanker's Test
ggplot(data = hypo_one_dataset, aes(x = Musical_Practice, y = Flanker_test,
                                    color = Musical_Practice)) +
  geom_boxplot(show.legend = FALSE) +
  stat_summary(fun.data = mean_se, color = "black") +
  xlab("Musical Practice (Total Hrs per Week") +
  ylab("Flanker's Test Unadjusted Score")  + 
  labs(title = "Musical Practice vs. Flanker's Test") + 
  theme(plot.title = element_text(size = rel(1.2), hjust = 0.5))

#Second Language vs. Flanker's Test
ggplot(data = hypo_one_dataset, aes(x = Second_Language, y = Flanker_test,
                                    color = Second_Language)) +
  geom_boxplot(show.legend = FALSE) +
  stat_summary(fun.data = mean_se, color = "green") +
  geom_dotplot(binaxis = "y",stackdir = "center", binwidth = 0.8) +
  xlab("Second Language(s)") +
  ylab("Flanker's Test Unadjusted Score")  + 
  labs(title = "Second Language(s) vs. Flanker's Test") + 
  theme(plot.title = element_text(size = rel(1.2), hjust = 0.5))

#Education Level vs. Flanker's Test
ggplot(data = hypo_one_dataset, aes(x = Education_Level, y = Flanker_test,
                                    color = Education_Level)) +
  geom_boxplot(show.legend = FALSE) +
  stat_summary(fun.data = mean_se, color = "black") +
  xlab("Highest Academic Degree") +
  ylab("Flanker's Test Unadjusted Score")  + 
  labs(title = "Highest Academic Degree vs. Flanker's Test") + 
  theme(plot.title = element_text(size = rel(1.2), hjust = 0.5))

#Ability to Pay Attention vs. Flanker's Test
ggplot(data = hypo_one_dataset, aes(x = Track_Activity, y = Flanker_test,
                                    color = Track_Activity)) +
  geom_boxplot(show.legend = FALSE) +
  stat_summary(fun.data = mean_se, color = "black") +
  xlab("Ability to Pay Attention") +
  ylab("Flanker's Test Unadjusted Score")  + 
  labs(title = "Ability to Pay Attention vs. Flanker's Test") + 
  theme(plot.title = element_text(size = rel(1.2), hjust = 0.5))
```
### Model Interpretation and Analysis:
```{r}
#Model Construction
hypo1_model_1 <- lm(data = hypo_one_dataset, Flanker_test ~ Track_Activity + Age + Second_Language + Education_Level + Musical_Practice)
hypo1_model_2 <- lm(data = hypo_one_dataset, Flanker_test ~ Musical_Practice + Age + Second_Language + Education_Level)

#Analysis and Comparison
kable(tidy(hypo1_model_1), digits = 3)
kable(tidy(Anova(hypo1_model_1, type = 2, alpha = 0.05)), digits = 3)
AIC(hypo1_model_1, hypo1_model_2)
```

```{r}
# Use augment to add fitted values and residuals to model data
hypo1_model_2_aug <- augment(hypo1_model_2)

# Plot the residuals against the values fitted by the model.
ggplot(hypo1_model_2_aug, aes(.fitted, .resid))+
  geom_point()

# Plot the studentized residuals against the fitted values.
ggplot(hypo1_model_2_aug, aes(.fitted, .std.resid))+
  geom_point()+
  geom_smooth(method = loess, formula = `y` ~ `x`, se = F)+
  geom_smooth(method=lm, formula = `y` ~ `x`)+
  geom_hline(yintercept = c(-2, 2), linetype=2, size=0.5)

# QQ Plot
ggplot(hypo1_model_2_aug, aes(sample=.std.resid))+
  stat_qq()+
  stat_qq_line()+
  geom_abline(slope=1, intercept=0, linetype=2)

hat_avg_model_2 = (4+1)/nrow(hypo1_model_2_aug)

# look at resid vs hat values
# hypo1_model_2_aug %>% 
#   pivot_longer(cols = c(.std.resid, .resid)) %>%
#   ggplot(aes(.hat, value))+
#   facet_wrap(vars(name))+
#   geom_point()+
#   # Line marking average hat value
#   geom_vline(xintercept = hat_avg_model_2, linetype = 2)+
#   # Line marking 2*average hat value
#   geom_vline(xintercept = 2 * hat_avg_model_2, linetype = 2, color="orange")+
#   # Line marking 3*average hat value
#   geom_vline(xintercept = 3 * hat_avg_model_2, linetype = 2, color="red")+
#   theme_bw()

#Cooks Distance:
hypo1_model_2_aug %>% 
  ggplot( aes(.hat, .std.resid, size=.cooksd))+
  geom_point(shape = 1)+
  geom_vline(xintercept = hat_avg_model_2, linetype = 2)+
  geom_vline(xintercept = 2 * hat_avg_model_2, linetype = 2, color="orange")+
  geom_vline(xintercept = 3 * hat_avg_model_2, linetype = 2, color="red")+
  geom_hline(yintercept = c(-2, 2), linetype = 2)+
    geom_text(aes(label=if_else(.hat>2*hat_avg_model_2 |.cooksd>=(2/sqrt(nrow(hypo1_model_2_aug))),
                              paste0("(",Musical_Practice, ", ", Flanker_test, ")"), "")), nudge_y = 0.2, size=4)+
  theme_bw()

hypo1_model_2_aug

```

## Hypothesis 2: The ability to recall from memory, proxied by the NIH Picture Sequence Memory Test, can be explained by the combined effect of relevant behavioral habits, a relevant brain volume, and a self-reported score when accounting for age and education. These behavioral habits are ones that have been connected in literature to better brain performance: musical practice and fluency in multiple languages. The brain volume considered is the parahippocampal volume, known in literature to be important for memory function. The self-reported score asks the subject about their ability to recall items in their day-to-day lives. 

```{r}
hypo_two_dataset <- tidy_dataset %>%
  select(ID,
         Pic_Seq_Mem_Test,
         Age,
         Musical_Practice,
         R_Parahippo_vol,
         L_Parahippo_vol,
         Est_Tot_intra_cranial_vol,
         Second_Language,
         Education_Level,
         Remembering
  ) %>% 
  mutate(Parahippo_vol = 
           (R_Parahippo_vol + L_Parahippo_vol) / Est_Tot_intra_cranial_vol)
# Total parahippocampal volume (PHC) is calculated as the sum of the left and right parahippocampal volumes, normalized to estimated total intracranial volume (PHC = (fs_parahpc_vol_l + fs_parahpc_vol_r) / (fs_etiv)) 

hypo_two_dataset
### TODO : description of Parahippo_vol in tibble is 'Right Parahippocal Volume', therefore need to fix ( " data.frame(Parahippo_vol, description = "Parahippocampal Volume as Fraction of Total Intracranial Volume") " ?)
```
### Statistical Hypothesis:

Ho: The NIH Picture Sequence Memory test scores will not be significantly different for different behavioral habits and brain volumes, accounting for age and education. 

Ha: NIH Picture Sequence Memory test scores will be significantly different for different behavioral habits and brain volumes, accounting for age and education. 

### Statistical Model:
$$\begin{aligned}
\hat{y}_{Pic.Seq.Mem.} = \beta_{Age}X_{Age}? + \beta_{Music}X_{Music}? +
\beta_{Language}X_{Language}? + \beta_{Education}X_{Education}? + \beta_{PHC}X_{PHC}? + \beta_{Remembering}X_{Remembering}?
\end{aligned}$$

### Visualization:
```{r}
#Age vs. Picture Sequence Memory Test
ggplot(data = hypo_two_dataset, aes(x = Age,
                                    y = Pic_Seq_Mem_Test)) +
  geom_point() +
  geom_smooth(method = lm, formula = `y` ~ `x`, se = F) +
  ylab("Picture Sequence Memory Test Score") +
  theme_bw()

#Musical Practice vs. Picture Sequence Memory Test
ggplot(data = hypo_two_dataset %>% filter(!is.na(Musical_Practice)), aes(x = Musical_Practice, y = Pic_Seq_Mem_Test,
                                    color=factor(Musical_Practice,labels=c("Less than 1 hour","1-2.5 hours","3-4.5 hours","5-6.5 hours")))) +
  geom_boxplot(show.legend = FALSE) +
  stat_summary(fun.data = mean_se, color = "black") +
  scale_x_discrete(labels=c("Less than 1 hour","1-2.5 hours","3-4.5 hours","5-6.5 hours")) +
  xlab("Musical Practice") +
  ylab("Picture Sequence Memory Test Score") +
  labs(color='Musical Practice') +
  theme_bw()
# TO DO : change " color=factor(Musical_Practice,labels=c("Less than 1 hour","1-2.5 hours","3-4.5 hours","5-6.5 hours")) " to " color=Musical Practice " if not including legend in final figure

#Second Language vs. Picture Sequence Memory Test
ggplot(data = hypo_two_dataset %>% filter(!is.na(Second_Language)), aes(x = Second_Language, y = Pic_Seq_Mem_Test,
                                    color = Second_Language)) +
  geom_boxplot(show.legend = FALSE) +
  stat_summary(fun.data = mean_se, color = "green") +
  geom_dotplot(binaxis = "y",stackdir = "center", binwidth = 0.8) +
  xlab("Second Language") +
  ylab("Picture Sequence Memory Test Score") +
  theme_bw()

#Education Level vs. Picture Sequence Memory Test
ggplot(data = hypo_two_dataset %>% filter(!is.na(Education_Level)), aes(x = Education_Level, y = Pic_Seq_Mem_Test,
                                    color = Education_Level)) +
  geom_boxplot(show.legend = FALSE) +
  stat_summary(fun.data = mean_se, color = "black") +
  scale_x_discrete(labels=c("High School","Associate's","Bachelor's","Master's","Doctorate/Professional")) +
  xlab("Education Level") +
  ylab("Picture Sequence Memory Test Score") +
  theme_bw()

#Parahippocampal Volume vs. Picture Sequence Memory Test
ggplot(data = hypo_two_dataset, aes(x = Parahippo_vol,
                                    y = Pic_Seq_Mem_Test)) +
  geom_point() +
  geom_smooth(method = lm, formula = `y` ~ `x`, se = F) + 
  xlab("Parahippocampal Volume") +
  ylab("Picture Sequence Memory Test Score") +
  theme_bw()

#Ability to Remember vs. Picture Sequence Memory Test
ggplot(data = hypo_two_dataset %>% filter(!is.na(Remembering)), aes(x = Remembering, y = Pic_Seq_Mem_Test,
                                    color = Remembering)) +
  geom_boxplot(show.legend = FALSE) +
  stat_summary(fun.data = mean_se, color = "black") +
  scale_x_discrete(labels=c("Not at all","A little bit","Somewhat","Quite a bit","Very much")) +
  xlab("Ability to Remember Things as Easily as Usual") +
  ylab("Picture Sequence Memory Test Score") +
  theme_bw()


### TODO : Apply chosen plot changes to other graphs after consulting with group (Musical Practice is the example plot with legend and x axis sublabels)
### TODO : Remove NA boxplot boxes (Or should we leave them in?)
### TODO : Remove values to prevent Warning messages? (additional data carpentry)
```

### Model Interpretation and Analysis:
```{r}
hypo2_model <- lm(data = hypo_two_dataset, formula = Pic_Seq_Mem_Test ~ Age + Education_Level + Musical_Practice + Second_Language + Parahippo_vol + Remembering)
kable(tidy(hypo2_model), digits = 3)
kable(tidy(Anova(hypo2_model, type = 2, alpha = 0.05)), digits = 3)
```
```{r}
hypo2_model_aug <- augment(hypo2_model)

#Hypothesis Two QQ plot
hypo2_model_aug%>%
    ggplot(aes(sample= .std.resid))+
  stat_qq()+
  stat_qq_line()+
   #title
  labs(
title = "QQ Plot showing Distribution of Standard
Residual Values")+

theme(plot.title = element_text(size = rel(1),
                                hjust = 0.5))
```


# Scientific Hypotheses (Planned Exploratory Analysis):
```{r exploratory-data-carpentry}
exp_dataset <- tidy_dataset %>%
  filter(redcap_event_name == "event_1_arm_1") %>%
  select(-redcap_event_name) 
# Y (MoCA Score) ~ fct1 (pac_pay_attention) + fct2 (pac_remember) + fct3 (bdi_indecisiveness) + fct4(pac_concentrate) 
#Model 2: understanding factors as related to cognitive impairment compared to moca scores
ggplot(exp_dataset, aes(Paying_Attention,Moca_Score,color = Paying_Attention))+
  geom_boxplot()
ggplot(exp_dataset, aes(Remembering,Moca_Score,color = Remembering))+
  geom_boxplot()
ggplot(exp_dataset, aes(Indecisiveness,Moca_Score,color = Indecisiveness))+
  geom_boxplot()
ggplot(exp_dataset, aes(Concentration,Moca_Score,color = Concentration))+
  geom_boxplot()
# If I drop NA's from every column, the result is only 27 observations which is concerning. It gets rid of indecisive scores of 2
MoCA_dropna <- exp_dataset %>%
  select(Flanker_test, Pic_Seq_Mem_Test,Paying_Attention,Remembering,Indecisiveness,Concentration,Moca_Score) %>%
  filter(Moca_Score < 25)

Moca_normal <- exp_dataset %>%
  select(Flanker_test, Pic_Seq_Mem_Test,Paying_Attention,Remembering,Indecisiveness,Concentration,Moca_Score) %>%
  filter(Moca_Score >= 25)

# %>%
#   drop_na(Paying_Attention,Remembering,Indecisiveness,Concentration)
```

#Unplanned Exploratory Analysis:

#Supplemental Data: